<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Routes/Subreddit/Subreddit.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Routes/Subreddit/Subreddit.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { Component } from 'react';
import './Subreddit.css';
import defImage from '../../assets/images/subreddit.png';
import Listings from '../../Components/Listings/Listings';
import Thread from '../Thread/Thread';
import { Link, Route, Switch, Router } from 'react-router-dom';
import data from '../../Mocks/subreddit-data.json';

import axios from '../../axios-orders';


let inDev = false;

export class Subreddit extends Component {
  state = {
    name: window.location.href.split("/").pop(),
    bio: '',
    threads: [],
    moderators: '',
    moderatorsList: [],
    subscribers: 0,
    subscribersList: [],
    date: '',
    rules: [],
    posts: [],
    subscribed: false,
    adminview: false,
    threadCreation: false,
    subredditEdit: false,
    threadsContent: [],
    flair: null,
    spoiler: false,
  }

  componentDidMount() {

    console.log("mounted");

    if (inDev === false) // &amp;&amp; ginprodReducer.globalInProduction)
    {
      let srName = this.state.name;
      axios.get('/sr/' + srName + '/meta')
        .then(resp => {
          console.log(resp);
          console.log(resp.data);
          if (resp.status == 200) {
            console.log(resp.data);
            this.setState({
              name: this.state.name,
              bio: resp.data.Bio,
              threads: resp.data.posts,
              moderators: resp.data.adminUsername,
              moderatorsList: resp.data.modUsername ? resp.data.modUsername : [resp.data.adminUsername],
              subscribers: resp.data.subscribed_users.length,
              subscribersList: resp.data.subscribed_users,
              subscribed: resp.data.subscribed_users.includes(localStorage.getItem("Username")) ? true : false,
              adminview: resp.data.modUsername.includes(localStorage.getItem("Username")) ? true : false,
              date: resp.data.date,
              rules: resp.data.rules,
              cover: resp.data.subredditFile
            }, () => {
              const isAdmin = this.state.moderators === localStorage.getItem("Username")
                || this.state.moderatorsList.includes(localStorage.getItem("Username"));
              this.setState({
                adminview: isAdmin,
                subscribed: isAdmin
              })
            })
            for (const threadID of resp.data.posts) {
              axios.get(`/sr/${srName}/thread/${threadID}`)
                .then(resp => {
                  if (resp.data &amp;&amp; resp.status === 200) {
                    let threads = this.state.threadsContent;
                    threads.push(resp.data);
                    this.setState({
                      threadsContent: threads
                    });
                  }
                });
            }
          }
          else if (resp.status === 404) {
            alert("Subreddit Not Found");
            return Response.json;
          }
        })
        .catch(error => {
          // alert(cons);
          console.log(error);
        })
    }
    else {

      this.setState({
        bio: data.subreddit.bio,
        threads: data.subreddit.threads,
        moderators: data.subreddit.adminUsername,
        subscribers: data.subreddit.subscribers,
        date: data.subreddit.date,
        rules: data.subreddit.rules,
      });
    }
    let token = localStorage.getItem("token");
    let username = localStorage.getItem("Username");
    for (let i = 0; i &lt; this.state.subscribers; i++) {
      if (username == this.state.subscribersList[i] || username == this.state.moderatorsList[i] || username == this.state.moderatorsList) {
        this.setState({
          subscribed: true
        })
      }
      if (username == this.state.moderators) {
        this.setState({
          adminview: true
        })
      }
    }
    this.handleChange = this.handleChange.bind(this);
    this.handleSubmit = this.handleSubmit.bind(this);
  };



  handleChange(e) {
    this.setState({
      spoiler: e.target.checked
    });
  }

  /**
   * For sending a subscribe request to the backend and updating the subscribed boolean state
   * @function srSubscribe
   * @param {event} - onClick event 
   */
  srSubscribe = (e) => {
    e.preventDefault();
    console.log('Subscribe Clicked');
    let headers = {
      auth: localStorage.getItem("token")
    }
    let SubredditName = this.state.name;
    axios.post('/sr/' + SubredditName + '/subs', null, { "headers": headers })
      .then(res => {
        if (res.status == 200) {
          console.log(res);

          console.log('subscribed!')
          this.setState({
            subscribed: true
          }
          );
        } else if (res.status === 404) {
          alert("Subreddit Not Found");
          return Response.json;
        }
      })
      .catch(error => {
        alert("Error Caught");
      })
  }
  /**
    * For sending an Unsubscribe request to the backend and updating the subscribed boolean state
    * @function srUnSubscribe
    * @param {event} - onClick event 
    */
  srUnSubscribe = (e) => {
    e.preventDefault();
    console.log('Unsubscribe Clicked');
    let headers = {
      auth: localStorage.getItem("token")
    }
    let SubredditName = this.state.name;
    axios.delete('/sr/' + SubredditName + '/subs', { "headers": headers })
      .then(res => {
        if (res.status == 200) {
          console.log(res);
          this.setState({
            subscribed: false
          }
          );
        } else if (res.status === 404) {
          alert("Subreddit Not Found");
          return Response.json;
        }
      })
      .catch(error => {
        alert("Error Caught");
      })
  }
  /**
    * For sending an delete request to the backend to delete the entire subreddit from the database
    * @function srUnSubscribe
    * @param {event} - onClick event 
    */
  delSubreddit = (e) => {
    e.preventDefault();
    console.log('Del Subreddit Clicked');
    let headers = {
      auth: localStorage.getItem("token")
    }
    let SubredditName = this.state.name;
    axios.delete('/sr/' + SubredditName, { "headers": headers })
      .then(res => {
        console.log(res);
        if (res.status == 200) {
          alert("Subreddit Deleted Successfully!");
          this.setState({
            subscribed: false
          }
          );
        }
        else if (res.status === 401) {
          alert("You're Not Authorised");
          return Response.json;
        }
      })
      .catch(error => {
        alert("Error Caught");
      })

  }
  /**
    * For changing the GUI and showing the fields for the thread creation
    * @function createThreadSidebar
    * @param {event} - onClick event 
    */
  createThreadSidebar = (e) => {
    e.preventDefault();
    console.log('Clicked on create thread sidebar');
    if (this.state.subscribed == false) {
      //CANNOT CREATE A POST UNLESS SUBSCRIBED
      alert('CANNOT CREATE A POST UNLESS SUBSCRIBED');
    }
    else {
      this.setState({
        threadCreation: true
      })

    }
  }
  /**
         * For changing the GUI and hiding the fields for the thread creation
         * @function CancelCreation
         * @param {event} - onClick event 
         */
  CancelCreation = (e) => {
    e.preventDefault();
    console.log('Clicked on Cancel thread sidebar');
    this.setState({
      threadCreation: false
    })
  }
  editSubreddit = (e) => {
    e.preventDefault();
    console.log("Clicked on the edit subredditbutton");
    if (this.state.adminview == false) {
      //CANNOT CREATE A POST UNLESS SUBSCRIBED
      alert('CANNOT EDIT A SUBREDDIT UNLESS IS MODERATOR');
    }
    else {
      this.setState({
        subredditEdit: true
      })
    }
  }
  cancelSubreddit = (e) => {
    e.preventDefault();
    console.log('Clicked on Cancel thread sidebar');
    this.setState({
      subredditEdit: false
    })
  }

  /**
   * For sending an post request to the backend and creating a thread in this subreddit
   * @function handleSubmit
   * @param {event} - onClick event 
   */
  handleSubmit = (e) => {
    e.preventDefault();

    const srdata = {
      "title": document.getElementById("threadTitleField").value,
      "threadBody": document.getElementById("threadBodyField").value,
      "spoiler": this.state.spoiler
    }
    if (this.state.imagePost) {
      srdata.base64image = this.state.imagePost
    }
    let headers = {
      auth: localStorage.getItem("token")
    }
    let SubredditName = this.state.name;
    axios.post('/sr/' + SubredditName + '/thread', srdata, { "headers": headers })
      .then(res => {
        console.log(res);
        if (res.status == 200) {
          alert("Thread Created Successfully!");
        } else if (res.status === 401 || res.status === 404) {
          alert("Thread Creation Unsuccessful");
          return Response.json;
        }
      })
      .catch(error => {
        alert("Errorrrrrrr Caught");
      })
  }

  handleEdit = (e) => {
    e.preventDefault();
    let newmods = this.state.moderatorsList;
    const newMod = document.getElementById("subredditmoderatorField").value;
    if (newMod) {
      newmods.push(newMod);
    }
    const srdata = {
      "newName": document.getElementById("subredditNameField").value,
      "newRules": [document.getElementById("subredditRule1Field").value, document.getElementById("subredditRule2Field").value, document.getElementById("subredditRule3Field").value],
      "newBio": document.getElementById("subredditBioField").value,
      "newMods": newmods,
      "base64image": this.state.image
    }

    let headers = {
      auth: localStorage.getItem("token")
    }
    let SubredditName = this.state.name;
    axios.put('/sr/' + SubredditName, srdata, { "headers": headers })
      .then(res => {
        console.log(res);
        if (res.status == 200) {
          alert("Thread Created Successfully!");
          let srName = this.state.name;
          axios.get('/sr/' + srName + '/meta')
            .then(resp => {
              console.log(resp);
              if (resp.status == 200) {
                console.log(resp.data.rules);
                console.log("length", resp.data.posts.length)
                window.location.href = "/r/" + SubredditName;
              }
            })
        } else if (res.status === 401 || res.status === 404) {
          alert("Thread Creation Unsuccessful");
          return Response.json;
        }
      })
      .catch(error => {
        alert("Error Caught");
      })
  }
  getThreads() {
    if (!this.state.threadsContent) return;
    return this.state.threadsContent.map(thr =>
      &lt;Thread
        id={thr._id}
        username={thr.creatorUsername}
        subreddit={thr.subredditName}
        title={thr.title}
        content={thr.body}
        upvotes={thr.votes}
      />);
  }
  /**
  * For changing the GUI and hiding the fields for the thread creation
  * @function CreateFlair 
  * @param {event} - Submition event 
  */
  CreateFlair(e) {
    e.preventDefault();

    let body = {
      srName: this.state.name,
      flair: e.target.querySelector('.flairInput').value
    }
    let headers = {
      'auth': localStorage.getItem('token')
    }
    axios.post('/user/CreateFlair', body, { "headers": headers })
      .then(response => {
        console.log('flair response', response);
        //Na hash3'al l server bta3 l backend 3andi 3shan hazbot feeh 7agat 
        //Ha sharo fa l mafrod ysht3'al...
        this.setState({
          flair: body.flair
        })
      })
      .catch(error => {

      })
  }
  handleNewImage(e) {
    const files = e.target.files;
    if (!files || !files.length) return;

    const reader = new FileReader();

    reader.onload = (eReader) => {
      if (!eReader.target || !eReader.target.result) return;
      this.setState({
        image: eReader.target.result
      });
    }

    reader.readAsDataURL(files[0]);

  }
  handleNewImagePost(e) {
    const files = e.target.files;
    if (!files || !files.length) return;

    const reader = new FileReader();

    reader.onload = (eReader) => {
      if (!eReader.target || !eReader.target.result) return;
      this.setState({
        imagePost: eReader.target.result
      });
    }

    reader.readAsDataURL(files[0]);

  }
  render() {
    console.log(this.state.flair);
    return (
      &lt;div className="subredditFixed">
        &lt;section id="subredditShowcase" style={{ backgroundImage: this.state.cover ? `url(http://18.217.163.16/api${this.state.cover})` : null }}>
          &lt;img src={defImage} alt="Subreddit Default" />
          &lt;h1>r/{this.state.name}&lt;/h1>
        &lt;/section>

        {/*&lt;nav id="subredditNavbar">
          &lt;div className="subredditContainer">
            &lt;div id="subredditSort">
              &lt;div className="subredditContainer">

                &lt;div className="srSortdropdownMenu">
                  &lt;button className='srSortdropButton'>
                    Sorting &lt;i class="downIcon fas fa-sort-down">&lt;/i>
                  &lt;/button>
                  &lt;div role='menu' className='srdropList'>
                    &lt;ul className='srSortdropUl'>
                      &lt;li className='srSortdropdownItem' className='sort toHome'>Hot&lt;/li>
                      &lt;li className='srSortdropdownItem' className='sort toHome'>New&lt;/li>
                      &lt;li className='srSortdropdownItem' className='sort toHome'>Controversial&lt;/li>
                      &lt;li className='srSortdropdownItem' className='sort toHome'>Top&lt;/li>
                      &lt;li className='srSortdropdownItem' className='sort toHome'>Rating&lt;/li>
                    &lt;/ul>

                  &lt;/div>
                &lt;/div>
              &lt;/div>
            &lt;/div>

          &lt;/div>
        &lt;/nav>*/}
        &lt;div class="subredditContainer">
          &lt;section id="subredditPageContent">
            &lt;div>
              {this.getThreads()}

            &lt;/div>
          &lt;/section>

          &lt;aside id="subredditSidebarContainer">
            &lt;div className="subredditSidebarComponent">
              &lt;h5>COMMUNITY DETAILS&lt;/h5>
              &lt;div className="srSidebarCompTitle">
                &lt;img src={defImage} alt="Subreddit Default" />
                r/{this.state.name}
              &lt;/div>
              &lt;div className="srSidebarSubscribers">
                {this.state.subscribers} &lt;br />
                Subscribers
                &lt;/div>
              &lt;div className="srSidebarBio">
                &lt;p>{this.state.bio}&lt;/p>
              &lt;/div>
              {
                this.state.moderators === localStorage.getItem("Username") ? &lt;span>&lt;/span>
                  : this.state.subscribed ? &lt;button className="srSidebarSubscribeButton" onClick={this.srUnSubscribe}>UNSUBSCRIBE&lt;/button>
                    : &lt;button className="srSidebarSubscribeButton" onClick={this.srSubscribe}>SUBSCRIBE&lt;/button>
              }
              &lt;button className="srSidebarSubscribeButton" onClick={this.createThreadSidebar}>CREATE A POST&lt;/button>
            &lt;/div>
            {
              this.state.subredditEdit ?
                &lt;div className="subredditSidebarComponent">
                  &lt;h5>EDIT SUBREDDIT&lt;/h5>
                  &lt;hr>&lt;/hr>
                  &lt;form onSubmit={this.handleEdit}>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="Subreddit New Name">Enter Subreddit Name&lt;/label>
                      &lt;textarea type="textarea" name="text" id="subredditNameField" placeholder="Enter Name Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="Rule1">Enter Rule &lt;/label>
                      &lt;textarea type="textarea" name="text" id="subredditRule1Field" placeholder="Enter Rule Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="Rule2">Enter Rule &lt;/label>
                      &lt;textarea type="textarea" name="text" id="subredditRule2Field" placeholder="Enter Rule Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="Rule3">Enter Rule &lt;/label>
                      &lt;textarea type="textarea" name="text" id="subredditRule3Field" placeholder="Enter Rule Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="Bio">Enter Bio &lt;/label>
                      &lt;textarea type="textarea" name="text" id="subredditBioField" placeholder="Enter Bio Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="Bio">Add a new moderator &lt;/label>
                      &lt;textarea type="textarea" name="text" id="subredditmoderatorField" placeholder="Enter Moderator Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="cover">Cover &lt;/label>
                      &lt;input type="file" name="cover" id="cover" onChange={this.handleNewImage.bind(this)} />
                    &lt;/div>
                    &lt;button className="srSidebarSubscribeButton">Edit Subreddit&lt;/button>
                    &lt;button type="button" className="srSidebarSubscribeButton" onClick={this.cancelSubreddit}>CANCEL&lt;/button>
                  &lt;/form>
                &lt;/div> : &lt;div>&lt;/div>
            }
            {
              this.state.threadCreation ?
                &lt;div className="subredditSidebarComponent">
                  &lt;h5>CREATE A POST&lt;/h5>
                  &lt;hr>&lt;/hr>
                  &lt;form onSubmit={this.handleSubmit}>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="ThreadTitle">Enter Title&lt;/label>
                      &lt;textarea type="textarea" name="text" id="threadTitleField" placeholder="Enter Title Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="ThreadBody">Enter Thread Body&lt;/label>
                      &lt;textarea type="textarea" name="text" id="threadBodyField" placeholder="Enter Body Here" />
                    &lt;/div>
                    &lt;div className="formGroupSrComponent">
                      &lt;label for="coverPost">Cover &lt;/label>
                      &lt;input type="file" name="coverPost" id="coverPost" onChange={this.handleNewImagePost.bind(this)} />
                    &lt;/div>
                    &lt;div className="formGroupThreadCheckbox">
                      &lt;label className="spoilerLabel" for="Spoiler">Is it a spoiler?&lt;/label>
                      &lt;input type="checkbox" name="Spoiler" id="Spoiler" onChange={this.handleChange} value={this.state.spoiler} />
                    &lt;/div>
                    &lt;button className="srSidebarSubscribeButton" >CREATE&lt;/button>
                    &lt;button className="srSidebarSubscribeButton" onClick={this.CancelCreation}>CANCEL&lt;/button>
                  &lt;/form>
                &lt;/div> : &lt;div>&lt;/div>
            }
            &lt;div className="subredditSidebarComponent">
              &lt;h5>MODERATORS &amp; ADMINS&lt;/h5>
              &lt;ul>
                {/*&lt;li className="moderatorSr" >&lt;Link to={`/user/${this.state.moderators}`}>u/{this.state.moderators}&lt;/Link>&lt;/li> */}
                {
                  this.state.moderatorsList.map(moderator => {
                    return (
                      &lt;li className="moderatorSr" key={moderator}>&lt;Link to={`/user/${this.state.moderators}`}>u/{this.state.moderators}&lt;/Link>&lt;/li>
                    );
                  })
                }
              &lt;/ul>
            &lt;/div>
            &lt;div className="subredditSidebarComponent">
              &lt;h5>RULES&lt;/h5>
              &lt;ol>
                {
                  this.state.rules.map(rule => {
                    return (
                      &lt;li className="rulesSr" key={rule}>{rule}&lt;/li>
                    );
                  })
                }
              &lt;/ol>
            &lt;/div>

            {
              this.state.adminview ? &lt;button className="srSidebarSubscribeButton" onClick={this.editSubreddit}>Edit Subreddit&lt;/button> : &lt;div>&lt;/div>
            }
            {
              this.state.adminview ? &lt;button className="srDeleteButton" onClick={this.delSubreddit}>Delete Subreddit&lt;/button> : &lt;div>&lt;/div>
            }
            &lt;div className="subredditSidebarComponent flairComp">
              &lt;h5>CREATE YOUR OWN NAME&lt;/h5>
              &lt;form id='flairForm' onSubmit={this.CreateFlair.bind(this)}>
                &lt;input
                  className='flairInput'
                  type='text'
                  placeholder='Flair' />
                &lt;button className="srSidebarSubscribeButton" type='submit' >Create a flair&lt;/button>
              &lt;/form>

            &lt;/div>

          &lt;/aside>

        &lt;/div>
      &lt;/div >
    )
  }
}

export default Subreddit
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#BlockUser">BlockUser</a></li><li><a href="global.html#CancelCreation">CancelCreation</a></li><li><a href="global.html#checkValidity">checkValidity</a></li><li><a href="global.html#CreateFlair">CreateFlair</a></li><li><a href="global.html#createThread">createThread</a></li><li><a href="global.html#createThreads">createThreads</a></li><li><a href="global.html#createThreadSidebar">createThreadSidebar</a></li><li><a href="global.html#filterList">filterList</a></li><li><a href="global.html#getFlairs">getFlairs</a></li><li><a href="global.html#getListing">getListing</a></li><li><a href="global.html#getMsgs">getMsgs</a></li><li><a href="global.html#getThreads">getThreads</a></li><li><a href="global.html#handleChange">handleChange</a></li><li><a href="global.html#handleClick">handleClick</a></li><li><a href="global.html#handledecrement">handledecrement</a></li><li><a href="global.html#handleIncrement">handleIncrement</a></li><li><a href="global.html#handleSubmit">handleSubmit</a></li><li><a href="global.html#srSubscribe">srSubscribe</a></li><li><a href="global.html#srUnSubscribe">srUnSubscribe</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat May 04 2019 17:12:25 GMT+0200 (Eastern European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
